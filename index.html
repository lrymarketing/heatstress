<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heat & Weather Check</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Apply Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinning animation for loader */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }
        /* Custom Cream Color for "Caution" */
        .bg-cream {
            background-color: #FFF8DC; /* Cornsilk/Cream */
            color: #5D4037; /* Dark Brown text for contrast */
        }
        /* Timeline colors matching the main logic */
        .card-cream { background-color: #FFF8DC; border-color: #e6dbc0; color: #5D4037; }
        .card-yellow { background-color: #fef08a; border-color: #fde047; color: #854d0e; }
        .card-orange { background-color: #fed7aa; border-color: #fdba74; color: #9a3412; }
        .card-red { background-color: #fecaca; border-color: #fca5a5; color: #991b1b; }
        .card-green { background-color: #dcfce7; border-color: #86efac; color: #166534; }
        
        /* Modal transition */
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow: hidden;
        }

        /* Hide scrollbar for horizontal scroll but keep functionality */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white w-full max-w-md p-6 sm:p-8 rounded-2xl shadow-lg relative">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Weather & Safety</h1>
            <p class="text-gray-500 mt-1">EQL Heat Index Check</p>
        </header>

        <main>
            <!-- Check Button -->
            <button id="checkButton" class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 ease-in-out flex items-center justify-center space-x-2">
                <!-- Inlined "navigate-circle-outline" icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="text-2xl w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"></path>
                </svg>
                <span>Check My Location</span>
            </button>

            <!-- Loading Spinner (hidden by default) -->
            <div id="loader" class="hidden w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-lg shadow-md flex items-center justify-center space-x-3">
                <div class="loader"></div>
                <span>Fetching Weather...</span>
            </div>

            <!-- Error Message Box (hidden by default) -->
            <div id="errorBox" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                <strong class="font-bold">Error:</strong>
                <span id="errorMessage" class="block sm:inline"></span>
            </div>

            <!-- Manual Location Input (hidden by default) -->
            <div id="manualInputBox" class="hidden mt-4 space-y-2">
                <label for="locationInput" class="block text-sm font-medium text-gray-700">Or enter location manually:</label>
                <div class="flex space-x-2">
                    <input type="text" id="locationInput" placeholder="e.g., 'Kirwan'" class="flex-grow block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <button id="searchButton" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400">
                        Search
                    </button>
                </div>
            </div>

            <!-- Results Section (hidden by default) -->
            <div id="results" class="hidden mt-8 space-y-6">
                
                <!-- Location -->
                <div>
                    <h2 class="text-center text-xl font-semibold text-gray-700" id="location"></h2>
                    <p class="text-center text-xs text-gray-400 mt-1" id="currentTimeLabel"></p>
                </div>

                <!-- Main Warning -->
                <div id="warningBox" class="relative p-6 rounded-2xl shadow-md text-center border-2 border-transparent transition-colors duration-300">
                    <!-- Info Button -->
                    <button id="infoButton" class="absolute top-3 right-3 p-1 rounded-full hover:bg-black hover:bg-opacity-10 focus:outline-none transition-colors" aria-label="More Info">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>

                    <p class="text-sm font-medium uppercase tracking-wider opacity-80 mb-1">Feels Like</p>
                    <h3 class="text-5xl font-bold mb-2" id="feelsLikeTemp"></h3>
                    <p class="text-3xl font-bold mt-1 uppercase tracking-wide" id="warningLevel"></p>
                    <p class="text-lg font-medium mt-2 opacity-90" id="warningMessage"></p>
                    <p class="text-xs mt-2 opacity-70">(Tap the ⓘ icon for required actions)</p>
                </div>

                <!-- Other Details Grid -->
                <div class="grid grid-cols-3 gap-3 pt-2">
                    <!-- Actual Temp -->
                    <div class="bg-gray-50 p-3 rounded-lg text-center shadow-sm">
                        <p class="text-[10px] uppercase font-bold text-gray-400 mb-1">Temp</p>
                        <p class="text-xl font-bold text-gray-800" id="actualTemp"></p>
                    </div>
                    <!-- Humidity -->
                    <div class="bg-gray-50 p-3 rounded-lg text-center shadow-sm">
                        <p class="text-[10px] uppercase font-bold text-gray-400 mb-1">Humidity</p>
                        <p class="text-xl font-bold text-gray-800" id="humidity"></p>
                    </div>
                    <!-- Rain -->
                    <div class="bg-gray-50 p-3 rounded-lg text-center shadow-sm">
                        <p class="text-[10px] uppercase font-bold text-gray-400 mb-1">Rain %</p>
                        <p class="text-xl font-bold text-gray-800" id="rain"></p>
                    </div>
                    <!-- Wind Speed -->
                    <div class="bg-gray-50 p-3 rounded-lg text-center shadow-sm">
                        <p class="text-[10px] uppercase font-bold text-gray-400 mb-1">Wind</p>
                        <p class="text-xl font-bold text-gray-800" id="wind"></p>
                    </div>
                    <!-- Wind Gusts (Updated Layout) -->
                    <div class="bg-gray-50 p-3 rounded-lg text-center shadow-sm">
                        <p class="text-[10px] uppercase font-bold text-gray-400 mb-1">Gusts (km/h)</p>
                        <p class="text-xl font-bold text-gray-800" id="gusts"></p>
                    </div>
                     <!-- UV Index -->
                     <div class="bg-gray-50 p-3 rounded-lg text-center shadow-sm">
                        <p class="text-[10px] uppercase font-bold text-gray-400 mb-1">UV Index</p>
                        <p class="text-xl font-bold text-gray-800" id="uvIndex"></p>
                    </div>
                </div>

                <!-- Work Day Timeline -->
                <div class="pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-end mb-3">
                        <h3 class="text-sm font-bold text-gray-700 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Work Day (7am-4pm)
                        </h3>
                        <!-- Risk Legend -->
                        <div class="flex space-x-1 text-[8px] font-medium text-gray-500">
                            <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-[#dcfce7] border border-green-300 mr-0.5"></span>Low</span>
                            <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-[#FFF8DC] border border-yellow-700 mr-0.5"></span>Caution</span>
                            <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-yellow-200 border border-yellow-400 mr-0.5"></span>Ext</span>
                            <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-orange-200 border border-orange-400 mr-0.5"></span>Dgr</span>
                            <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-red-200 border border-red-400 mr-0.5"></span>Ext Dgr</span>
                        </div>
                    </div>
                    
                    <!-- Horizontal Scroll Container -->
                    <div class="overflow-x-auto scrollbar-hide pb-2 px-1">
                        <div class="flex space-x-3" id="hourlyTimeline">
                            <!-- JS will inject hourly cards here -->
                        </div>
                    </div>
                </div>

                <!-- Disclaimer Footer -->
                <div class="pt-4 border-t border-gray-200">
                    <p class="text-[10px] text-gray-400 leading-tight text-justify">
                        <strong>Disclaimer:</strong> Managing heat risk in the workplace is a shared responsibility.
                        This Heat Index is based on the environmental conditions of temperature and relative humidity. Heat stress risk is not just based on environmental conditions, but the interaction of the
                        environmental conditions with the type of work being performed and the health and fitness status of the individual(s) performing the work. The heat index is simply a guideline to
                        trigger additional controls and discussions under escalating heat stress ratings. Additional controls can be implemented at any time and work should be stopped at any time if it is considered unsafe to proceed, regardless of the Heat Index rating.
                    </p>
                </div>

            </div>
        </main>
    </div>

    <!-- Modal Overlay -->
    <div id="infoModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            
            <!-- Modal Content -->
            <div class="modal-content py-4 text-left px-6">
                <!-- Title -->
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-2xl font-bold" id="modalTitle">Title</p>
                    <div class="modal-close cursor-pointer z-50 p-2" id="closeModalBtn">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                            <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                        </svg>
                    </div>
                </div>

                <!-- Body -->
                <div class="my-5 text-sm text-gray-700 space-y-3" id="modalBody">
                    <!-- Content injected by JS -->
                </div>

                <!-- Footer -->
                <div class="flex justify-end pt-2">
                    <button id="closeModalBottom" class="px-4 py-2 bg-blue-600 p-3 rounded-lg text-white hover:bg-blue-700">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // HTML Elements
        const checkButton = document.getElementById('checkButton');
        const loader = document.getElementById('loader');
        const results = document.getElementById('results');
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');
        const manualInputBox = document.getElementById('manualInputBox');
        const locationInput = document.getElementById('locationInput');
        const searchButton = document.getElementById('searchButton');
        const currentTimeLabel = document.getElementById('currentTimeLabel');

        const locationEl = document.getElementById('location');
        const feelsLikeTempEl = document.getElementById('feelsLikeTemp');
        const warningLevelEl = document.getElementById('warningLevel');
        const warningMessageEl = document.getElementById('warningMessage');
        const warningBoxEl = document.getElementById('warningBox');
        
        const actualTempEl = document.getElementById('actualTemp');
        const humidityEl = document.getElementById('humidity');
        const windEl = document.getElementById('wind');
        const rainEl = document.getElementById('rain');
        const gustsEl = document.getElementById('gusts');
        const uvIndexEl = document.getElementById('uvIndex');
        const hourlyTimeline = document.getElementById('hourlyTimeline');

        // Modal Elements
        const infoButton = document.getElementById('infoButton');
        const infoModal = document.getElementById('infoModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const closeModalBottom = document.getElementById('closeModalBottom');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalOverlay = document.querySelector('.modal-overlay');

        let currentWarningLevel = "";

        // Guidance Data
        const guidanceData = {
            "Caution": {
                colorClass: "text-yellow-900",
                intro: "Apply the planning and response operating principles as per the EQL standard for heat stress management."
            },
            "Extreme Caution": {
                colorClass: "text-yellow-600",
                intro: "Apply the planning and operation considerations as per the ‘Caution’ rating above in addition to giving further consideration to:",
                bullets: [
                    "Discuss at SMEACS/HazChat conversation that the heat stress rating has now moved to ‘Extreme Caution’ and confirm with workers they feel fit for the work, especially new workers and those that may not be acclimatised.",
                    "Consider resourcing options or task adjustments may need to be made (e.g. additional crew, more frequent rotations).",
                    "Consider that individual factors such as worker health status, previous day(s) heat exposure may have an increasing impact risk.",
                    "Acknowledge self-pacing as an important self-regulatory way for workers to minimise excessive increases in core temperature.",
                    "Consider the availability of controls such as access to shade, air conditioning, electrolyte replacement products (e.g. Sqwincher) at this higher heat stress rating.",
                    "Heat Stress Eskies are to be carried on vehicles and applied as part of the first aid process for a significant heat illness."
                ]
            },
            "Danger": {
                colorClass: "text-orange-600",
                intro: "Apply the planning and operation considerations as per the prior heat stress ratings above in addition to the following mandatory requirements:",
                bullets: [
                    "Discuss at SMEACS/HazChat conversation that the heat stress rating has now moved to ‘Danger’ and confirm with workers they feel fit for the work, especially those that may not be acclimatised.",
                    "All work is reviewed and assessed on a case by case basis in consultation to establish agreed resources, noting potential limitations on the volume and type of work being performed. This may require consideration to postponing of other works to allow additional resources to be re-directed to support associated breaks and manage the heat hazard.",
                    "Modify the work to rest ratio (i.e. less work and more rest), with the work to rest ratio being determined by the group conducting the work and taking into consideration the health status, acclimatisation status, and nature of work being performed by the team.",
                    "Rest periods should be taken in a shaded/cooled or preferably airconditioned area e.g. vehicle cab.",
                    "Heat Stress Eskies are to be carried on vehicles and applied as part of the first aid process for a significant heat illness."
                ]
            },
            "Extreme Danger": {
                colorClass: "text-red-600",
                intro: "Undertake an assessment that includes consideration of whether the work should continue. <br><br>Apply the planning and operation considerations as per prior ratings above in addition to the following mandatory requirements:",
                bullets: [
                    "No long-distance walking (>2klms) without breaks in shaded/cooled or air-conditioning locations.",
                    "If field work is to proceed, the work and approach is to be consulted with the team and resourcing agreed to enable adequate rotations and rest breaks to take place, commensurate to the environmental conditions and discussion around individual factors.",
                    "In the event that field work is to proceed the ‘Extreme Danger’ heat stress rating must be communicated to workers in the Hazchat.",
                    "Modify the work to rest ratio (i.e. less work and more rest), with the work to rest ratio being determined by the group conducting the work and taking into consideration the health status, acclimatisation status, and nature of work being performed by the team.",
                    "Rest periods should be taken in a shaded/cooled or preferably airconditioned area e.g. vehicle cab.",
                    "Heat Stress Eskies are to be carried on vehicles and applied as part of the first aid process for a significant heat illness."
                ]
            },
            "Low Risk": {
                colorClass: "text-green-600",
                intro: "Conditions are generally safe. Continue to follow standard safety and hydration procedures."
            }
        };

        // Modal Logic
        function toggleModal() {
            infoModal.classList.toggle('opacity-0');
            infoModal.classList.toggle('pointer-events-none');
            document.body.classList.toggle('modal-active');

            if (!infoModal.classList.contains('opacity-0')) {
                const data = guidanceData[currentWarningLevel];
                modalTitle.innerText = currentWarningLevel;
                modalTitle.className = `text-2xl font-bold ${data.colorClass || 'text-gray-800'}`;
                
                let html = `<p class="font-semibold">${data.intro}</p>`;
                if (data.bullets) {
                    html += `<ul class="list-disc pl-5 space-y-2 mt-3">`;
                    data.bullets.forEach(bullet => {
                        html += `<li>${bullet}</li>`;
                    });
                    html += `</ul>`;
                }
                modalBody.innerHTML = html;
            }
        }

        infoButton.addEventListener('click', toggleModal);
        closeModalBtn.addEventListener('click', toggleModal);
        closeModalBottom.addEventListener('click', toggleModal);
        modalOverlay.addEventListener('click', toggleModal);

        // Location & Search Logic
        checkButton.addEventListener('click', () => {
            checkButton.classList.add('hidden');
            loader.classList.remove('hidden');
            results.classList.add('hidden');
            errorBox.classList.add('hidden');
            manualInputBox.classList.add('hidden'); 
            
            if (!navigator.geolocation) {
                fallbackGetLocation();
                return;
            }
            navigator.geolocation.getCurrentPosition(handleGeoSuccess, handleGeoError, { enableHighAccuracy: true, timeout: 10000 });
        });

        searchButton.addEventListener('click', () => {
            const cityName = locationInput.value;
            if (!cityName) {
                showError("Please enter a city or suburb name.");
                return;
            }
            loader.classList.remove('hidden');
            checkButton.classList.add('hidden');
            errorBox.classList.add('hidden');
            manualInputBox.classList.add('hidden');
            results.classList.add('hidden');

            geocodeAndFetch(cityName);
        });

        function handleGeoSuccess(position) {
            fetchDataAndDisplay(position.coords.latitude, position.coords.longitude);
        }

        function handleGeoError(error) {
            console.warn("Geolocation failed, trying IP fallback:", error.message);
            fallbackGetLocation();
        }

        async function fallbackGetLocation() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                if (!response.ok) throw new Error('IP service failed');
                const data = await response.json();
                
                if (data.latitude && data.longitude) {
                    fetchDataAndDisplay(data.latitude, data.longitude, data.city);
                } else {
                    throw new Error('Invalid IP data');
                }
            } catch (error) {
                console.error("IP Fallback Error:", error);
                showError("Could not automatically detect location. Please enter it manually.");
            }
        }

        async function geocodeAndFetch(cityName) {
            try {
                const geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cityName)}&count=1&format=json`;
                const response = await fetch(geoUrl);
                if (!response.ok) throw new Error("Location search failed.");
                
                const geoData = await response.json();
                if (!geoData.results || geoData.results.length === 0) {
                    throw new Error(`Could not find "${cityName}".`);
                }

                const location = geoData.results[0];
                
                const displayParts = [];
                if (location.name) displayParts.push(location.name);
                if (location.admin1) displayParts.push(location.admin1);
                else if (location.country) displayParts.push(location.country);
                
                const name = displayParts.join(', ');

                fetchDataAndDisplay(location.latitude, location.longitude, name);

            } catch (error) {
                showError(error.message);
            }
        }

        async function fetchDataAndDisplay(lat, lon, manualCityName = null) {
            try {
                // Fetch Weather (Now includes hourly data for timeline)
                const weather = await getWeatherData(lat, lon);
                
                let city = manualCityName;
                if (!city) {
                    city = await getCityName(lat, lon);
                }

                // Current Warning
                const warning = getWarningData(weather.current.apparent_temperature);
                currentWarningLevel = warning.level;

                // Display Main Data
                displayResults(weather, warning, city);
                
                // Render Timeline (7am - 4pm)
                renderTimeline(weather.hourly);

            } catch (error) {
                console.error(error);
                showError("Could not fetch weather data. Please try again.");
            }
        }

        async function getWeatherData(lat, lon) {
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation_probability,wind_speed_10m,wind_gusts_10m&hourly=temperature_2m,apparent_temperature,precipitation_probability,uv_index&timezone=auto&forecast_days=1`;
            
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error("Weather API error");
            const data = await response.json();
            
            if (!data.current) throw new Error("No current weather data");

            const currentHourIso = data.current.time.substring(0, 13);
            const hourIndex = data.hourly.time.findIndex(t => t.startsWith(currentHourIso));
            const currentUV = hourIndex !== -1 ? data.hourly.uv_index[hourIndex] : 0;

            return {
                current: {
                    temperature: Math.round(data.current.temperature_2m),
                    humidity: data.current.relative_humidity_2m,
                    apparent_temperature: Math.round(data.current.apparent_temperature),
                    wind_speed: Math.round(data.current.wind_speed_10m),
                    wind_gusts: Math.round(data.current.wind_gusts_10m),
                    rain_probability: data.current.precipitation_probability,
                    uv_index: currentUV
                },
                hourly: data.hourly
            };
        }

        function renderTimeline(hourly) {
            hourlyTimeline.innerHTML = "";
            
            // Calculate nearest hour for highlighting (e.g. 1:56 -> 2:00, so 14:00)
            const now = new Date();
            let currentHourNum = now.getHours();
            if (now.getMinutes() >= 30) {
                currentHourNum += 1;
            }

            for (let i = 0; i < hourly.time.length; i++) {
                const timeStr = hourly.time[i];
                const hourPart = timeStr.split('T')[1]; // "07:00"
                const hourNum = parseInt(hourPart.split(':')[0], 10);

                // Filter for 7am to 4pm
                if (hourNum >= 7 && hourNum <= 16) {
                    const feelsLike = Math.round(hourly.apparent_temperature[i]);
                    const rainProb = hourly.precipitation_probability[i];
                    
                    // Determine color for "Feels Like" timeline card
                    // Using class names defined in <style>
                    let cardClass = "card-green"; // default < 27
                    if (feelsLike >= 52) cardClass = "card-red";
                    else if (feelsLike >= 40) cardClass = "card-orange";
                    else if (feelsLike >= 33) cardClass = "card-yellow";
                    else if (feelsLike >= 27) cardClass = "card-cream";

                    // Check if this is the current/nearest hour
                    const isCurrent = (hourNum === currentHourNum);
                    const highlightClass = isCurrent ? "ring-2 ring-blue-600 ring-offset-1 scale-105 z-10 bg-white" : "";
                    const timeBadge = isCurrent ? `<span class="absolute -top-2 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white text-[8px] px-1.5 py-0.5 rounded-full">NOW</span>` : "";

                    // Format time (e.g. "07:00" -> "7am")
                    const ampm = hourNum >= 12 ? 'pm' : 'am';
                    const displayHour = hourNum % 12 || 12; 
                    const timeLabel = `${displayHour}${ampm}`;

                    const card = document.createElement('div');
                    card.className = `relative flex-shrink-0 w-24 p-2 rounded-xl border flex flex-col items-center justify-center text-center shadow-sm transition-transform ${cardClass} ${highlightClass}`;
                    card.innerHTML = `
                        ${timeBadge}
                        <span class="text-xs font-bold opacity-70 mb-1">${timeLabel}</span>
                        <span class="text-xl font-bold">${feelsLike}°</span>
                        <span class="text-[9px] opacity-70">Feels Like</span>
                        <div class="mt-2 flex items-center space-x-1 opacity-90">
                             <!-- Rain Umbrella Icon -->
                             <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M12 6c-3.87 0-7 3.13-7 7h14c0-3.87-3.13-7-7-7zm0-2c5.2 0 9.6 3.4 10.8 8H21v1c0 3.1-2.3 5.7-5.3 6.3v2.7h-2V19h-1.7v3h-2v-3H8v-2.7C5 15.7 2.7 13.1 2.7 10v-1h1.2C5.1 7.4 9.5 4 14.7 4h-2.7z"/></svg>
                             <span class="text-xs font-bold">${rainProb}%</span>
                        </div>
                    `;
                    
                    // Auto-scroll to the current hour if found
                    if (isCurrent) {
                        setTimeout(() => {
                            card.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        }, 500);
                    }

                    hourlyTimeline.appendChild(card);
                }
            }
        }

        async function getCityName(lat, lon) {
            try {
                const apiUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
                const response = await fetch(apiUrl, { headers: { 'Accept-Language': 'en-US' } });
                if (!response.ok) return "Your Location";
                
                const data = await response.json();
                const addr = data.address;

                const specificName = addr.suburb || addr.neighbourhood || addr.village || addr.hamlet || addr.city_district;
                const broadName = addr.town || addr.city || addr.municipality;
                const state = addr.state;

                if (specificName && state) {
                    return `${specificName}, ${state}`;
                } else if (specificName) {
                    return specificName;
                } else if (broadName) {
                    return broadName;
                }
                return "Your Location";
            } catch (e) {
                return "Your Location";
            }
        }

        function getWarningData(feelsLike) {
            if (feelsLike >= 52) {
                return {
                    level: "Extreme Danger",
                    message: "Critical heat stress risk. Stop work if unsafe.",
                    bgClass: "bg-red-600",
                    textClass: "text-white"
                };
            } else if (feelsLike >= 40) {
                return {
                    level: "Danger",
                    message: "Heat stroke likely. Mandatory rest breaks.",
                    bgClass: "bg-orange-500",
                    textClass: "text-white"
                };
            } else if (feelsLike >= 33) {
                return {
                    level: "Extreme Caution",
                    message: "Take frequent breaks. Monitor hydration.",
                    bgClass: "bg-yellow-400",
                    textClass: "text-gray-900"
                };
            } else if (feelsLike >= 27) {
                return {
                    level: "Caution",
                    message: "Plan work carefully. Stay hydrated.",
                    bgClass: "bg-cream",
                    textClass: "text-yellow-900"
                };
            } else {
                return {
                    level: "Low Risk",
                    message: "Conditions are within standard limits.",
                    bgClass: "bg-green-500",
                    textClass: "text-white"
                };
            }
        }

        function displayResults(weather, warning, city) {
            locationEl.innerText = city;
            
            // Display current time
            const now = new Date();
            currentTimeLabel.innerText = `Checked at ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            
            feelsLikeTempEl.innerText = `${weather.current.apparent_temperature}°C`;
            warningLevelEl.innerText = warning.level;
            warningMessageEl.innerText = warning.message;
            
            warningBoxEl.className = `relative p-6 rounded-2xl shadow-md text-center border-2 border-transparent transition-colors duration-300 ${warning.bgClass} ${warning.textClass}`;

            actualTempEl.innerText = `${weather.current.temperature}°C`;
            humidityEl.innerText = `${weather.current.humidity}%`;
            windEl.innerText = `${weather.current.wind_speed} km/h`;
            rainEl.innerText = `${weather.current.rain_probability}%`;
            gustsEl.innerText = `${weather.current.wind_gusts}`; // Removed unit, added to label
            uvIndexEl.innerText = `${weather.current.uv_index}`;

            loader.classList.add('hidden');
            results.classList.remove('hidden');
            checkButton.classList.remove('hidden');
        }

        function showError(message) {
            errorMessage.innerText = message;
            errorBox.classList.remove('hidden');
            manualInputBox.classList.remove('hidden');
            loader.classList.add('hidden');
            checkButton.classList.remove('hidden');
        }
    </script>
</body>
</html>
